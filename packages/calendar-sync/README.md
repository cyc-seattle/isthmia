# @cyc-seattle/calendar-sync

Syncs events between Google Calendar and Google Spreadsheet.

## Features

- Sync events from Google Calendar to Google Spreadsheet
- Sync events from Google Spreadsheet to Google Calendar
- Bidirectional sync support
- CLI tool for easy usage
- Library API for programmatic usage
- Rate-limited API calls to respect Google's quotas

## Installation

```bash
pnpm add @cyc-seattle/calendar-sync
```

## Authentication

This package uses Google Application Default Credentials (ADC). Before using, authenticate with:

```bash
gcloud auth application-default login
```

## CLI Usage

### Sync Calendar to Spreadsheet

```bash
calendar-sync sync-to-spreadsheet \
  --calendar-id "primary" \
  --spreadsheet-id "1abc..." \
  --worksheet-name "Events"
```

### Sync Spreadsheet to Calendar

```bash
calendar-sync sync-to-calendar \
  --calendar-id "team@group.calendar.google.com" \
  --spreadsheet-id "https://docs.google.com/spreadsheets/d/1abc..." \
  --worksheet-name "Events"
```

### With Date Range

```bash
calendar-sync sync-to-spreadsheet \
  --calendar-id "primary" \
  --spreadsheet-id "1abc..." \
  --worksheet-name "Events" \
  --sync-from "2024-01-01" \
  --sync-to "2024-12-31"
```

### List Calendar Events

```bash
calendar-sync list-calendar \
  --calendar-id "primary" \
  --sync-from "2024-01-01" \
  --sync-to "2024-12-31"
```

### List Spreadsheet Events

```bash
calendar-sync list-spreadsheet \
  --spreadsheet-id "1abc..." \
  --worksheet-name "Events"
```

### Options

- `--calendar-id <id>` - Google Calendar ID (e.g., "primary" or "calendar@group.calendar.google.com")
- `--spreadsheet-id <id>` - Google Spreadsheet ID or URL
- `--worksheet-name <name>` - Worksheet name in the spreadsheet
- `--sync-from <date>` - Sync events from this date/time (ISO format, e.g., "2024-01-01"). Only for `sync-to-spreadsheet`
- `--sync-to <date>` - Sync events until this date/time (ISO format, e.g., "2024-12-31"). Only for `sync-to-spreadsheet`
- `--logging <format>` - Logging format: `pretty` or `json` (default: `pretty`)
- `-v, --verbose` - Increase log level (can be repeated: `-v` for info, `-vv` for debug)

## Library Usage

```typescript
import { google } from "googleapis";
import { CalendarClient, SpreadsheetClient, EventSynchronizer, SyncConfig } from "@cyc-seattle/calendar-sync";

// Initialize Google Auth
const auth = new google.auth.GoogleAuth({
  scopes: ["https://www.googleapis.com/auth/calendar", "https://www.googleapis.com/auth/spreadsheets"],
});

// Initialize clients
const calendarClient = new CalendarClient(auth);
const spreadsheetClient = new SpreadsheetClient(auth, "spreadsheet-id");
await spreadsheetClient.initialize();

// Create synchronizer
const synchronizer = new EventSynchronizer(calendarClient, spreadsheetClient);

// Define sync configuration
const config: SyncConfig = {
  calendar: {
    calendarId: "primary",
  },
  spreadsheet: {
    spreadsheetId: "spreadsheet-id",
    worksheetName: "Events",
  },
  direction: "to-spreadsheet",
};

// Perform sync
const result = await synchronizer.sync(config);
console.log(`Created: ${result.created}, Updated: ${result.updated}, Deleted: ${result.deleted}`);
```

## Spreadsheet Format

The spreadsheet uses human-readable column headers:

- `Event Id` - Event ID (auto-generated by Google Calendar)
- `Title` - Event title/summary
- `Description` - Event description (optional)
- `Start Time` - Start date/time (ISO 8601 format)
- `End Time` - End date/time (ISO 8601 format)
- `Location` - Event location (optional)
- `All Day` - Whether this is an all-day event (`TRUE` or `FALSE`)

Additional columns will be stored as metadata and preserved during sync.

### Example Spreadsheet

| Event Id | Title           | Description | Start Time          | End Time            | Location | All Day |
| -------- | --------------- | ----------- | ------------------- | ------------------- | -------- | ------- |
| abc123   | Team Meeting    | Weekly sync | 2024-01-15T10:00:00 | 2024-01-15T11:00:00 | Office   | FALSE   |
| def456   | Company Holiday | New Year    | 2024-01-01          | 2024-01-02          |          | TRUE    |

## How It Works

### Calendar to Spreadsheet

1. Fetches all events from Google Calendar (within time range if specified)
2. Fetches all events from the spreadsheet
3. Creates new rows for events that don't exist in the spreadsheet
4. Updates existing rows if the event data has changed
5. Deletes rows for events that no longer exist in the calendar

### Spreadsheet to Calendar

1. Fetches all events from the spreadsheet
2. Fetches all events from Google Calendar
3. Creates new calendar events that don't exist
4. Updates existing calendar events if the data has changed
5. Deletes calendar events that no longer exist in the spreadsheet

## API Rate Limits

This package automatically throttles requests to respect Google's API quotas:

- Google Sheets API: 60 read requests + 60 write requests per minute per user
- Automatic retry with exponential backoff on failures

## Development

```bash
# Build the package
pnpm run build

# Clean build artifacts
pnpm run clean
```

## License

Apache-2.0
